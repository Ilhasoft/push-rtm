- extends "public_base_v2.html"

-load compress thumbnail humanize ureport i18n


- block content
  %section.section.page-title-block.block-content.booklet-bg
    .columns
      .column.page-title
        Opinions
      .column.categories-dropdown
        .dropdown
          .dropdown-trigger
            .button
              .dropdown-text
                %span
                  BROWSE CATEGORIES
                %span.icon.is-small
                  %i.fas.fa-angle-down(aria-hidden="true")
  %section.section.poll-title-block.block-content
    .columns
      .column.is-half.questions-count
        {% blocktrans count questions=latest_poll.get_questions|length %}
          {{ questions }} question
        {% plural %}
          {{ questions }} questions
        {% endblocktrans %}
      .column.is-half.has-text-right
        .recent-results.is-inline-block
          Recent Poll Results
        .poll-category.is-inline-block
          {{ latest_poll.category.name|upper }}
    .columns
      .column.is-half.poll-title
        {{ latest_poll.title }}
      .column.is-half.has-text-right
        .poll-stats
          .responses-count.is-inline-block.has-text-centered
            .number-figure
              {{ latest_poll.responded_runs|intcomma }}
            .number-label
              - trans "RESPONSES"
          .responses-percentage.is-inline-block.has-text-centered
            .number-figure
              {{ latest_poll.response_percentage }}
            .number-label
              - trans "RESPONSE RATE"
  - for question in latest_poll.get_questions
    %section.section.columns.is-paddingless.is-marginless.poll-question-block
        - if not forloop.counter|divisibleby:2
          .column.is-half.block-content(class="for{{ forloop.counter0}}")
            .columns.is-multiline
              .column.is-full.is-size-5.has-text-weight-semibold
                {{ question.title }}
              .column.is-full.is-size-7.has-text-weight-semibold
                {% blocktrans with responded=question.get_responded|intcomma polled=question.get_polled|intcomma %}
                  {{ responded }} responded out of {{ polled }} polled
                {% endblocktrans %}

        .column.is-half.block-content
          .columns
            .column
              .is-small
                -trans "FILTER BY:"
              .tabs.is-boxed
                %ul
                  - if question.is_open_ended
                    %li.is-active(data-tab='keywords-chart-{{question.id}}')
                      %a
                        -trans "Keywords"
                  - else
                    %li.is-active(data-tab='all-chart-{{question.id}}')
                      %a
                        -trans "ALL"
                    %li(data-tab='age-chart-{{question.id}}')
                      %a
                        -trans "AGE"
                    %li(data-tab='gender-chart-{{question.id}}')
                      %a
                        -trans "GENDER"
                    %li(data-tab='map-chart-{{question.id}}')
                      %a
                        -trans "LOCATION"
              .tabs-content
                - if question.is_open_ended
                  .tab-content.is-active(data-content='keywords-chart-{{question.id}}')
                    .poll-question-keywords(id="graph-keywords-question-{{question.id}}" data-question="{{question.id}}")                
                      WIP
                -else
                  .tab-content.is-active(data-content='all-chart-{{question.id}}')
                    .poll-question-graph-all(id="graph-all-question-{{question.id}}" data-question="{{question.id}}")
                  .tab-content.is-active(data-content='age-chart-{{question.id}}')
                    .poll-question-graph-age(id="graph-age-question-{{question.id}}" data-question="{{question.id}}")
                  .tab-content.is-active(data-content='gender-chart-{{question.id}}')
                    .poll-question-graph-gender(id="graph-gender-question-{{question.id}}" data-question="{{question.id}}")
                  .tab-content(data-content='map-chart-{{question.id}}')
                    .poll-map{ data-question: "{{ question.id }}", id: "map-{{ question.id }}" }
                      .loading-placeholder{id:"map-{{ question.id }}-placeholder"}
                          %img{src:"{{ STATIC_URL }}img/loading.gif"}
        
        - if forloop.counter|divisibleby:2
          .column.is-half.block-content(class="for{{ forloop.counter0}}")
            .columns.is-multiline
              .column.is-full.is-size-5.has-text-weight-semibold
                {{ question.title }}
              .column.is-full.is-size-7.has-text-weight-semibold
                {% blocktrans with responded=question.get_responded|intcomma polled=question.get_polled|intcomma %}
                  {{ responded }} responded out of {{ polled }} polled
                {% endblocktrans %}

- block rsrs
  %section.section.poll-story-title-block.block-content
    .columns.is-multiline
      - for story in related_stories|slice:"1"
        .column.is-full.is-size-4.has-text-weight-semibold.booklet-bg
          {{ story.title }}
        .column.is-full
          {{ story.created_on|date:"M j. Y" }}
        -if story.get_written_by
          .column.is-full
            - trans "BY"
            {{ story.get_written_by|upper }}
          
        .column.is-full
          {{ story.content|safe }}  

  - if latest_poll
    %section.section.block-content
      .columns
        .column.is-full
          .fb-comments(data-href="{% org_host_link %}{% url 'v2.public.opinion_read' latest_poll.pk %}" data-width="100%" data-numposts="5")


- block extra-style
  {{ block.super }}

  :css
    .hero-container {
      {% if latest_poll %}
      {% thumbnail latest_poll.get_category_image "1280x678" crop="top" as im %}
        background-image:url('{{im.url}}');
      {% empty %}
        background-image: url('{{ STATIC_URL }}img/missing_image_placeholder.jpg');
      {% endthumbnail %}
      {% endif%}
    }

    .hero-small-background {
      {% if latest_poll %}
      {% thumbnail latest_poll.get_category_image "768x508" crop="top" as im %}
        background-image:url('{{im.url}}');
      {% empty %}
        background-image: url('{{ STATIC_URL }}img/missing_image_placeholder.jpg');
      {% endthumbnail %}
      {% endif%}
    }

    .poll-map {
      height: 500px;
      width: 100%;
    }

    .poll-map svg {
      height: 480px;
    }

    .leaflet-container {
      background: #fff;
    }

    .top-color {
      color: rgb(0,104,55);
    }

    .other-color {
      color: rgb(165,0,38);
    }

    .poll-word-cloud {
      width: 100%;
      min-height: 750px;
    }

    .scale {
      {% if org|config:"is_global" %}
      display: none;
      {% endif %}
    }

-block extra-script
  {{ block.super }}
  <script src="{{ STATIC_URL }}js/jqcloud.min.js"></script>
  {% compress js %}
  <script type="text/coffeescript" src="{{ STATIC_URL }}coffee/locations.coffee" />
  <script type="text/coffeescript" src="{{ STATIC_URL }}coffee/all_polls.coffee" />
  {% endcompress %}

  {% include "public/strings_values.html" %}
  :javascript

    $(function(){
      $(".poll-question-graph-all").each(function(){
        var question = $(this).attr("data-question");
        $.ajax({url:'/pollquestion/' + question + '/results/', dataType: "json"}).done(function(result){

          if(!result){
            return;
          }

          var results = result[0];

          var categories = [];
          var data = [['Element', 'Density', { role: 'style' }, {role: 'annotation'}]];
          var colors = ['#BBB','#004411'];


          if (results.categories.length > 0) {
          var total = 0;
          for (i=0; i<results.categories.length; i++){
            category = results.categories[i];
            total += category.count;
          }
          var percentage_lookup = {};
          for (i=0; i<results.categories.length; i++){
            category = results.categories[i];
            label = category.label.trim().toUpperCase();
            categories.push(label);
            percentage = (category.count == 0) ? 0 : category.count * 100 / total;
            percentage_lookup[label] = Math.round(percentage);
            if (parseInt(percentage_lookup[label])) {
              data.push([label, percentage, "color: " + colors[i%colors.length], label]);
            }
          }
          } 

          google.charts.load('current', {'packages':['bar']});
          google.charts.setOnLoadCallback(drawChart);

          function drawChart() {
            var chdata = google.visualization.arrayToDataTable(data, false);

            var options = {
              vAxis: {
                textPosition: "none",
              },
              bar: {
                groupWidth: 40,
              },
              vAxis: {
                minValue: 0,
                slantedTextAngle: 45,
                slantedText: true,
              },
              hAxis: {
                slantedTextAngle: 45,
                slantedText: true,
              },
              chartArea: {
                left: 0,
                top: 0,
                width: "100%",
                height: "100%",
              },
              legend: { position: "none" },
              width: 500,
              height: 60 * results.categories.length,
              bars: 'horizontal' // Required for Material Bar Charts.
            };

            var chart = new google.visualization.BarChart(document.getElementById('graph-all-question-' + question));

            chart.draw(chdata, google.charts.Bar.convertOptions(options));
          }

        });
      });
  
      $(".poll-question-graph-gender").each(function(){
        var question = $(this).attr("data-question");
        var segment = {"gender": "Gender"}
        $.ajax({url:'/pollquestion/' + question + '/results/?segment=' + encodeURIComponent(JSON.stringify(segment)), dataType: "json"}).done(function(result){

          if(!result){
            return;
          }

          var results = result;

          var genders = [];

          var categories_by_gender = {}
          var total_by_catedory = {};
          
          for (i=0; i<results.length; i++){
            result = results[i];
            gender = result.label;
            genders.push(gender);
            for (j=0; j<result.categories.length; j++){
              category = result.categories[j];
              label = category.label.trim().toUpperCase();
              if(!(label in categories_by_gender)) {
                categories_by_gender[label] = {};
                total_by_catedory[label] = 0;
              }
              categories_by_gender[label][gender] = category.count;
              total_by_catedory[label] += category.count;
            }
          }

          var data = [];
          headers = genders.slice();
          headers.unshift("Category");
          data.push(Array.from(headers));
          

          var percentage_lookup = {};

          for (key in categories_by_gender) {
            percentage_lookup[key] = {}
            key_row = [key]
            total_key = total_by_catedory[key];
            for (i=0; i<genders.length; i++){
              gender = genders[i];
              count = categories_by_gender[key][gender];

              percentage = (count == 0) ? 0 : count * 100 / total_key; 
              key_row.push(percentage);
            }
            data.push(key_row);

          }

          console.log(data);



          google.charts.load('current', {'packages':['corechart', 'bar']});
          google.charts.setOnLoadCallback(drawChart);

          function drawChart() {
            var chdata = google.visualization.arrayToDataTable(data, false);

            var options = {
              chartArea: {
                left: 0,
                top: 0,
                width: "100%",
              },
              vAxis: {
                minValue: 0,
              },

              bar: {
                groupWidth: 20,
              },
              legend: {
                position: "bottom",
              },
              series: {
                0: {visibleInLegend: true, annotations: "FOo", axis: "Foo"},
                1: {visibleInLegend: true, axis: "Bar"},
              },
              width: 500,
              height: 600,
              seriesType: 'bars',
            };

            var chart = new google.visualization.ColumnChart(document.getElementById('graph-gender-question-' + question));
            google.visualization.events.addListener(chart, 'ready', function() {
              $('#graph-gender-question-' + question).parent('.tab-content').removeClass('is-active')
            });
            chart.draw(chdata, google.charts.Bar.convertOptions(options));
          }
        });
      });

      $(".poll-question-graph-age").each(function(){
        var question = $(this).attr("data-question");
        var segment = {"age": "Age"}
        $.ajax({url:'/pollquestion/' + question + '/results/?segment=' + encodeURIComponent(JSON.stringify(segment)), dataType: "json"}).done(function(result){

          if(!result){
            return;
          }

          var results = result;
          console.log(results);

          var genders = [];

          var categories_by_gender = {}
          var total_by_catedory = {};
          
          for (i=0; i<results.length; i++){
            result = results[i];
            gender = result.label;
            genders.push(gender);
            for (j=0; j<result.categories.length; j++){
              category = result.categories[j];
              label = category.label.trim().toUpperCase();
              if(!(label in categories_by_gender)) {
                categories_by_gender[label] = {};
                total_by_catedory[label] = 0;
              }
              categories_by_gender[label][gender] = category.count;
              total_by_catedory[label] += category.count;
            }
          }

          var data = [];
          console.log(genders);
          headers = genders.slice();
          headers.unshift("Category");
          data.push(Array.from(headers));

          var percentage_lookup = {};

          for (key in categories_by_gender) {
            percentage_lookup[key] = {}
            key_row = [key]
            total_key = total_by_catedory[key];
            for (i=0; i<genders.length; i++){
              gender = genders[i];
              count = categories_by_gender[key][gender];

              percentage = (count == 0) ? 0 : count * 100 / total_key; 
              key_row.push(percentage);
            }
            data.push(key_row);

          }

          console.log(data);


          google.charts.load('current', {'packages':['corechart', 'bar']});
          google.charts.setOnLoadCallback(drawChart);

          function drawChart() {
            var chdata = google.visualization.arrayToDataTable(data, false);

            var options = {
              chartArea: {
                left: 0,
                top: 0,
                width: "100%",
              },
              bar: {
                groupWidth: 60,
              },
              series: {

              },
              legend: {
                position: "bottom",
              },
              width: 500,
              height: 600,
            };

            var chart = new google.visualization.ColumnChart(document.getElementById('graph-age-question-' + question));
            google.visualization.events.addListener(chart, 'ready', function() {
              $('#graph-age-question-' + question).parent('.tab-content').removeClass('is-active')
            });

            chart.draw(chdata, google.charts.Bar.convertOptions(options));
          }
        });
      });
    });
    
    $(function(){

      $(".poll-question-tab").on('click', function (){
        $(this).parent('.poll-question-tabs').children('.poll-question-tab').removeClass('active');
        $(this).parent('.poll-question-tabs').children('.poll-question-tab').children('a').removeClass('primary-bg-color')
        $(this).parent('.poll-question-tabs').children('.poll-question-tab').children('a').addClass('primary-color')

        $(this).addClass('active');
        $(this).children('a').removeClass('primary-color');
        $(this).children('a').addClass('primary-bg-color');
      });

      $(".poll-question-tab").on('shown.bs.tab', function(e) {
         var tabPaneShown = e.target.getAttribute('href');
         var mapDiv = $(tabPaneShown).children('.poll-map');

         if (mapDiv.length) {
            var map = mapDiv.data('map');
            map.invalidateSize(false);
         }
      });


      $.ajax({url:'/boundaries/', dataType: "json"}).done(function(boundaries){
        $(".poll-map").each(function(){
          var question = $(this).attr("data-question");
          var colorList = {{ colors_map|safe }};
          var map = window.initMap('map-' + question, boundaries, question, '{{ district_zoom|lower }}' === 'true', '{{ ward_zoom|lower }}' === 'true', colorList=colorList);

          $(this).data('map', map);
        });
      });

      $(".poll-word-cloud").each(function(){
        var question = $(this).attr("data-question");
        $.ajax({url:'/pollquestion/' + question + '/results/', dataType: "json"}).done(function(result){

          if(!result){
            return;
          }

          var results = result[0];
          var cloudData = [];

          for (i=0; i<=25 && i<=results.categories.length; i++){
            word = results.categories[i];
            if (word){
              label = word.label.trim().toUpperCase();
              cloudData.push({ text: label, weight: Math.sqrt(word.count)})
            }
          }

          $('#word-cloud-' + question + '-placeholder').hide();
          $('#word-cloud-' + question).jQCloud(cloudData);

        });
      });
    });
