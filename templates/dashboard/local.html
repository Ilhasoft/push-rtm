{% extends "base.html" %}
{% load i18n static sass_tags ureport %}

{% block nav_item %}page-dashboard{% endblock %}

{% block css_extra %}
  <link rel="stylesheet" href="{% sass_src 'css/dashboard/dashboard.scss' %}">
  <link rel="stylesheet" href="{% sass_src 'plugins/tooltip/tooltip.scss' %}">
{% endblock %}

{% block content %}
  <section class="section">
    <h1 class="title">{{ request.org }}</h1>
  </section>

  <section class="section">
    <div class="box is-shadowless p-40">
      <div class="flex space-between">
        <div>
          <span class="card-title has-text-weight-bold">SDGs being tracked</span>
          <span class="tooltip top left-m-10">
            <i class="material-icons info-icon">info</i>
            <span class="tooltip-content">{% trans 'Number of total messages received addressing each SDG'%}</span>
          </span>
        </div>
        <div class="dropdown is-hoverable">
          <div class="dropdown-trigger">
            <div aria-haspopup="true" aria-controls="dropdown-menu">
              <span>{% trans "Filter by" %}</span>
              <span class="icon is-small">
                <i class="fas fa-angle-down" aria-hidden="true"></i>
              </span>
            </div>
          </div>
          <div class="dropdown-menu" id="dropdown-menu" role="menu">
            <div class="dropdown-content">
              <a href="{% autosort sdg_track_last_week '' true %}" class="dropdown-item">{% trans "Last 7 days" %}</a>
              <a href="{% autosort sdg_track_last_month '' true %}" class="dropdown-item">{% trans "Last 30 days" %}</a>
              <a href="{% autosort sdg_track_last_month '' true %}" class="dropdown-item">{% trans "Last 12 months" %}</a>
              <a href="{% autosort sdg_track_since_inception '' true %}" class="dropdown-item">{% trans "Since Inception" %}</a>
            </div>
          </div>
        </div>
      </div>
      <div class="has-text-grey-light">Last 12 months</div>
      <canvas id="bubbleChart"></canvas>
      <div class="card-title has-text-weight-bold bottom-p-20">SDGs not being tracked</div>
      <ul class="untracked-sgd">
        {% for key, value in sdgs_bubble_data.not_tracked_sdgs %}
          <li class="untracked-sgd__item">
            <div class="untracked-sgd__item__color sdg-{{key}}"></div>
            <div class="untracked-sgd__item__label">{{key}} {{value}}</div>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="box is-shadowless is-paddingless">
      <div class="columns is-marginless">
        <div class="column is-three-fifths border-right p-40">
          <span class="card-title has-text-weight-bold">Surveys Partial Results</span>
          <span class="tooltip top left-m-10">
            <i class="material-icons info-icon">info</i>
            <span class="tooltip-content">{% trans 'Partial SDG results for the lastest ongoing surveys'%}</span>
          </span>
          <div class="selected-question top-m-30">
            <div class="selected-question__title bottom-m-30">
              {{ survey_result_raffled_question }}</br>
               <!-- Nome da Survey, Falta tag HTML 
               {{ survey_result_raffled_question.poll }}
               -->
               {% if not survey_result_doughnut_data %}
                {% trans "No date for chart yet" %}
               {% endif %}
            </div>
            <div class="selected-question__chart">
<!--              perguntas fechadas-->
              <canvas id="questionChart"></canvas>
<!--              perguntas abertas-->
<!--              <div id="wordCloud"></div>-->
            </div>
          </div>
        </div>
        <div class="column is-paddingless">
          <div class="flex space-between has-text-weight-bold p-40">
            <div class="card-title">{{ survey_result_sdg_questions|length }} Questions</div>
            <div class="dropdown is-hoverable">
              <div class="dropdown-trigger">
                <div aria-haspopup="true" aria-controls="dropdown-menu">
                  <span>Filter by</span>
                  <span class="icon is-small">
                <i class="fas fa-angle-down" aria-hidden="true"></i>
              </span>
                </div>
              </div>
              <div class="dropdown-menu" role="menu">
                <div class="dropdown-content">
                  {% for key, value in SDG_LIST %}
                    <a href="{% url 'dashboard.local' %}{% urlparams survey_result_sdg=key %}" class="dropdown-item">SDG {{ key }}</a>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="questions-list">
            {% for question in survey_result_sdg_questions %}
              <div class="questions-list__item p-30 border-bottom">
                <a href="#">{{ question}}</a>
              </div>
            {% empty %}
              <div class="questions-list__item p-30 border-bottom">
                {% trans 'There are no question registered with SDG ' %} {{ survey_result_sdg.0 }} - {{ survey_result_sdg.1 }}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div class="box is-shadowless p-40">
      <div class="flex space-between">
        <div class="card-title has-text-weight-bold">Message Metrics</div>
        <div class="dropdown is-hoverable">
          <div class="dropdown-trigger">
            <div aria-haspopup="true" aria-controls="dropdown-menu">
              <span>{% trans "Filter by" %}</span>
              <span class="icon is-small">
                <i class="fas fa-angle-down" aria-hidden="true"></i>
              </span>
            </div>
          </div>
          <div class="dropdown-menu" id="dropdown-menu" role="menu">
            <div class="dropdown-content">
              <a href="#" class="dropdown-item">{% trans "Last 7 days" %}</a>
              <a href="#" class="dropdown-item">{% trans "Last 30 days" %}</a>
              <a href="#" class="dropdown-item">{% trans "Last 12 months" %}</a>
              <a href="#" class="dropdown-item">{% trans "Since Inception" %}</a>
            </div>
          </div>
        </div>
      </div>
      <div class="bottom-p-20 has-text-grey-light">Last 12 months</div>
      <div class="flex flex-end top-m-20">
        <div class="dropdown is-hoverable">
          <div class="dropdown-trigger">
            <div aria-haspopup="true" aria-controls="dropdown-menu">
              <span>{% trans "All channels" %}</span>
              <span class="icon is-small">
                <i class="fas fa-angle-down" aria-hidden="true"></i>
              </span>
            </div>
          </div>
          <div class="dropdown-menu" id="dropdown-menu" role="menu">
            <div class="dropdown-content">
              <a href="#" class="dropdown-item">Channel 1</a>
              <a href="#" class="dropdown-item">Channel 2</a>
              <a href="#" class="dropdown-item">Channel 3</a>
            </div>
          </div>
        </div>
      </div>
      <canvas id="channelsChart" height="100"></canvas>
      <div class="card-title has-text-weight-bold top-m-50">Messages by Channel</div>
      <div class="columns is-multiline top-m-30">
        <div class="column is-one-fifth">
          <div class="flex">
            <div class="tooltip top flex align-center">
              <div class="right-m-10">
                {% if channel_type == 'telegram' %}
                  <span class="channel-icon icon-telegram"></span>
                {% else %}
                  <span class="channel-icon icon-phone"></span>
                {% endif %}
              </div>
              <div>
                <div class="flex align-center">
                  <span class="channel-number is-size-5 has-text-weight-bold">894.789</span>
<!--                  se cresceu -->
                    <i class="material-icons has-text-success">trending_up</i>
<!--                  senão -->
                    <i class="material-icons has-text-danger">trending_down</i>
                </div>
                <div>Telegram</div>
              </div>
              <div class="tooltip-content channel-tooltip flex flex-center p-20">
                <div class="flex">
                  <div class="right-m-10">
                    {% if channel_type == 'telegram' %}
                      <span class="channel-icon icon-telegram"></span>
                    {% else %}
                      <span class="channel-icon icon-phone"></span>
                    {% endif %}
                  </div>
                  <div>
                    <div class="is-size-6 bottom-p-20">Global Average</div>
                    <div class="flex">
                      <div>
                        <div class="flex align-center">
                          <span class="channel-number is-size-5 has-text-weight-bold">894.789</span>
<!--                          se cresceu -->
                            <i class="material-icons has-text-success">trending_up</i>
<!--                          senão -->
                            <i class="material-icons has-text-danger">trending_down</i>
                        </div>
                        <div class="is-size-6">Telegram</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="columns">
      <div class="column">
        <div class="box is-shadowless">
          <div class="top-p-20 left-p-20 flex space-between">
            <div class="card-title has-text-weight-bold">Most used Channels</div>
            <div class="dropdown is-hoverable">
              <div class="dropdown-trigger">
                <div aria-haspopup="true" aria-controls="dropdown-menu">
                  <span>{% trans "Filter by" %}</span>
                  <span class="icon is-small">
                <i class="fas fa-angle-down" aria-hidden="true"></i>
              </span>
                </div>
              </div>
              <div class="dropdown-menu" id="dropdown-menu" role="menu">
                <div class="dropdown-content">
                  <a href="#" class="dropdown-item">{% trans "Last 7 days" %}</a>
                  <a href="#" class="dropdown-item">{% trans "Last 30 days" %}</a>
                  <a href="#" class="dropdown-item">{% trans "Last 12 months" %}</a>
                  <a href="#" class="dropdown-item">{% trans "Since Inception" %}</a>
                </div>
              </div>
            </div>
          </div>
          <div class="left-p-20 bottom-p-20 has-text-grey-light">Last 12 months</div>
          <div class="columns">
            <div class="column">
              <canvas id="localMostUsedChannels"></canvas>
            </div>
            <div class="column">
              <canvas id="globalMostUsedChannels"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="column is-one-fifth">
        <div class="surveys-card box is-shadowless">
          <div class="card-title left-p-10 top-p-10 bottom-p-20">
            <span class="has-text-weight-bold">Surveys</span>
            <span class="tooltip top left-m-10">
              <i class="material-icons info-icon">info</i>
              <span class="tooltip-content">{% trans 'Surveys being conducted through the RTM'%}</span>
            </span>
          </div>
          <div class="surveys-info has-text-centered bottom-p-30 border-bottom">
            <div class="surveys-info__number">175</div>
            <div class="surveys-info_unct">Brasil</div>
          </div>
          <div class="surveys-info has-text-centered top-p-30 bottom-p-30">
            <div class="surveys-info__number">--</div>
            <div class="surveys-info_unct">Global</div>
          </div>
        </div>
      </div>
    </div>
    <div class="box is-shadowless">
      <div class="card-title p-20 has-text-weight-bold">RapidPro Contacts</div>
      <div class="columns p-20">
        <div class="column is-three-fifths">
          <div class="has-text-weight-bold bottom-m-20">Contacts growth over time</div>
          <canvas id="contactsChart"></canvas>
        </div>
        <div class="column">
          <div class="has-text-weight-bold bottom-m-20">Portion of Global Total Contacts</div>
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block js_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
  <script src="{% static 'plugins/wordcloud/d3.js' %}"></script>
  <script src="{% static 'plugins/wordcloud/d3.layout.cloud.js' %}"></script>

{{ sdgs_bubble_data.datasets|json_script:'SDGSBubbleChartDataDatasets' }}
{{ survey_result_doughnut_data|json_script:'SurveyResultDoughnutData' }}

  <script>
    let bubbleCtx = document.getElementById('bubbleChart').getContext('2d');
    let bubbleChart = new Chart(bubbleCtx, {
      type: 'bubble',
      options: {
        responsive: true,
        legend: {
          labels: {
            fontSize: 14,
            padding: 18,
            usePointStyle: true,
          },
          position: 'left',
        },
        layout: {
          padding: {
            top: 50,
          }
        },
        plugins: {
          datalabels: {
            display: false,
          }
        },
      },
      data: {
        datasets: JSON.parse(document.getElementById('SDGSBubbleChartDataDatasets').textContent)
      }
    });

    let donutCtx = document.getElementById('questionChart').getContext('2d');
    let questionChart = new Chart(donutCtx, {
      type: 'doughnut',
        data: JSON.parse(document.getElementById('SurveyResultDoughnutData').textContent),
        options: {
          legend: {
            labels: {
              fontSize: 14,
              padding: 18,
              usePointStyle: true,
            },
            position: 'left',
          },
          plugins: {
            datalabels: {
              formatter: (value, ctx) => {
                let sum = 0;
                let dataArr = ctx.chart.data.datasets[0].data;
                dataArr.map(data => {
                  sum += data;
                });
                let percentage = parseInt((value * 100 / sum));
                return percentage > 0 ? percentage + "%" : "";
              },
              color: '#fff',
            }
          }
        },
    });

    let channelsCtx = document.getElementById('channelsChart').getContext('2d');
    let channelsChart = new Chart(channelsCtx, {
      type: 'line',
      data: {
        labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
        datasets: [{
          label: 'Sent',
          borderColor: '#c9f4ff',
          backgroundColor: '#c9f4ff',
          data: [5, 10, 4, 14, 7, 6, 8, 9, 3, 10, 8, 7],
        }, {
          label: 'Received',
          borderColor: '#03aeef',
          backgroundColor: '#03aeef',
          data: [9, 6, 8, 13, 5, 12, 10, 11, 12, 9, 16, 8],
        }, {
          label: 'Fail',
          borderColor: '#0400a4',
          backgroundColor: '#0400a4',
          data: [10, 7, 16, 19, 15, 8, 12, 13, 15, 12, 10, 7],
        }],
      },
      options: {
        legend: {
          labels: {
            padding: 18,
            usePointStyle: true,
          },
          position: 'top',
        },
        scales: {
          xAxes: [{
            gridLines: {
              color: "rgba(0, 0, 0, 0)",
            }
          }],
        },
        plugins: {
          datalabels: {
            display: false,
          }
        }
      }
    });

    let localMostUsedCtx = document.getElementById('localMostUsedChannels').getContext('2d');
    let localMostUsedChannels = new Chart(localMostUsedCtx, {
      type: 'doughnut',
      data: {
        labels: [
          'Facebook',
          'Whatsapp',
          'SMS'
        ],
        datasets: [{
          data: [30, 25, 45],
          backgroundColor: [
            '#97d9f6',
            '#03aeef',
            '#0e08e9',
          ],
          borderColor: "rgba(255, 255, 255, 0.1)",
        }],
      },
      options: {
        title: {
          fontSize: '16',
          display: true,
          text: 'Brasil',
          position: 'top',
        },
        legend: {
          labels: {
            padding: 18,
            usePointStyle: true,
          },
          position: 'left',
        },
        plugins: {
          datalabels: {
            formatter: (value, ctx) => {
              let sum = 0;
              let dataArr = ctx.chart.data.datasets[0].data;
              dataArr.map(data => {
                sum += data;
              });
              let percentage = parseInt((value * 100 / sum));
              return percentage > 0 ? percentage + "%" : "";
            },
            color: '#fff',
          }
        }
      },
    });

    let globalMostUsedCtx = document.getElementById('globalMostUsedChannels').getContext('2d');
    let globalMostUsedChannels = new Chart(globalMostUsedCtx, {
      type: 'doughnut',
      data: {
        labels: [
          'Facebook',
          'Whatsapp',
          'SMS'
        ],
        datasets: [{
          data: [30, 25, 45],
          backgroundColor: [
            '#97d9f6',
            '#03aeef',
            '#0e08e9',
          ],
          borderColor: "rgba(255, 255, 255, 0.1)",
        }],
      },
      options: {
        title: {
          fontSize: '16',
          display: true,
          text: 'Global',
          position: 'top',
        },
        legend: {
          labels: {
            padding: 18,
            usePointStyle: true,
          },
          position: 'left',
        },
        plugins: {
          datalabels: {
            formatter: (value, ctx) => {
              let sum = 0;
              let dataArr = ctx.chart.data.datasets[0].data;
              dataArr.map(data => {
                sum += data;
              });
              let percentage = parseInt((value * 100 / sum));
              return percentage > 0 ? percentage + "%" : "";
            },
            color: '#fff',
          }
        }
      },
    });

    let pieCtx = document.getElementById('pieChart').getContext('2d');
    let pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: [
          'Other UNCTs',
          'Brasil',
        ],
        datasets: [{
          data: [75, 25],
          backgroundColor: [
            '#03aeef',
            '#0054e2',
          ],
          borderColor: "rgba(255, 255, 255, 0.1)",
        }],
      },
      options: {
        aspectRatio: 1.5,
        legend: {
          labels: {
            padding: 18,
            usePointStyle: true,
          },
          position: 'top',
        },
        plugins: {
          datalabels: {
            formatter: (value, ctx) => {
              let sum = 0;
              let dataArr = ctx.chart.data.datasets[0].data;
              dataArr.map(data => {
                sum += data;
              });
              let percentage = parseInt((value * 100 / sum));
              return percentage > 0 ? percentage + "%" : "";
            },
            color: '#fff',
          }
        }
      },
    });

    let contactsCtx = document.getElementById('contactsChart').getContext('2d');
    let contactsChart = new Chart(contactsCtx, {
      type: 'line',
      data: {
        labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
        datasets: [
          {
            label: 'Brasil',
            borderColor: '#0400a4',
            backgroundColor: '#0400a4',
            data: [9, 12, 20, 22, 14, 12, 19],
          }, {
            label: 'Global Average',
            borderColor: '#00adf3',
            backgroundColor: '#00adf3',
            data: [15, 20, 30, 35, 39, 42, 56],
        }]
      },
      options: {
        legend: {
          labels: {
            padding: 18,
            usePointStyle: true,
          },
          position: 'top',
        },
        scales: {
          xAxes: [{
            gridLines: {
              color: "rgba(0, 0, 0, 0)",
            }
          }],
        },
        plugins: {
          datalabels: {
            display: false,
          }
        }
      }
    });

    const availableWordCloudColors = ['#89e7ff', '#03aeef', '#0054e2', '#0400a4'];
    const words = ["water", "climate", "life", "rights", "industry", "work", "words"].map(function (word, index) {
      return {
        text: word,
        size: 10 + Math.random() * 90,
      };
    });

    function fillWordColor(d,i){
      return availableWordCloudColors[i % availableWordCloudColors.length];
    }

    let width = 250, height = 250;

    let wordCloud = d3.scale.category20();
    d3.layout.cloud()
      .words(words)
      .rotate(function() { return ~~(Math.random() * 2) * 90; })
      .font("Impact")
      .fontSize(function(d) { return d.size; })
      .on("end", draw)
      .start();
    function draw(words) {
      d3.select("#wordCloud").append("svg")
        .attr("width", '60%')
        .attr("height", '60%')
        .attr('viewBox','0 0 ' + Math.min(width,height) + ' ' + Math.min(width,height))
        .attr('preserveAspectRatio','xMinYMin')
        .append("g")
        .attr("transform", "translate(" + Math.min(width,height) / 2 + "," + Math.min(width,height) / 2 + ")")
        .selectAll("text")
        .data(words)
        .enter().append("text")
        .style("font-size", function (d) {
          return d.size + "px";
        })
        .style("font-family", "Impact")
        .style("fill", function (d, i) {
          return wordCloud(i);
        })
        .attr("text-anchor", "middle")
        .attr("transform", function (d) {
          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
        })
        .style('fill', fillWordColor)
        .text(function (d) {
          return d.text;
        });
    }
  </script>

{% endblock %}
