{% extends "base.html" %}
{% load i18n static sass_tags humanize ureport %}

{% block nav_item %}page-surveys{% endblock %}

{% block css_extra %}
  <link rel="stylesheet" href="{% static 'plugins/checkbox/checkbox.min.css' %}">
  <link rel="stylesheet" href="{% sass_src 'plugins/tooltip/tooltip.scss' %}">
  <link rel="stylesheet" href="{% sass_src 'css/polls/survey_results.scss' %}"/>
{% endblock %}

{% block content %}
  <section class="section top-p-0">
    <nav class="breadcrumb" aria-label="breadcrumbs">
      <ul>
        {% if request.user.is_superuser %}
        <li><a href="{% url 'polls.poll_list' %}">{% trans 'Global Surveys'%}</a></li>
        {% else %}
        <li><a href="{% url 'polls.poll_list' %}">{% trans 'Surveys'%}</a></li>
        {% endif %}
        <li class="is-active"><a href="#" aria-current="page">{% trans 'Survey Results'%}</a></li>
      </ul>
    </nav>
  </section>

  <section class="section">
    <h1 class="title">{% trans 'Survey Results'%}</h1>
  </section>
  
  <section class="section">
    <div class="columns is-mobile">
      <div class="column is-one-third-mobile is-one-quarter">
        <aside class="survey-filters">
          {% if request.user.is_superuser %}
            <div class="border-bottom p-30">
              <h3 class="bottom-m-10">
                <img class="right-m-5" src="{% static 'svg/unct.svg' %}" alt="">
                <span>UNCTs</span>
              </h3>
              <div class="control has-icons-left">
                <form>
                  <input class="input is-medium search" name="query" placeholder="{% trans 'Search'%}" value="{{ query }}">
                  <span class="icon is-left">
                  <i class="material-icons">search</i>
                </span>
                </form>
              </div>
            </div>
          {% endif %}
          <div class="survey-filters-content p-30">
            <h3 class="bottom-m-10">
              <img class="right-m-5" src="{% static 'svg/sdg.svg' %}" alt="">
              <span>SDG</span>
            </h3>

            {% for sdg in SDGS %}
              <div class="sdg-checkbox">
                <input class="is-checkradio" type="checkbox" id="sdg{{sdg.0}}" name="sdg{{sdg.0}}">
                <label for="sdg{{sdg.0}}" title="{{ sdg.1 }}">{{ sdg.1 }}</label>
              </div>
            {% endfor %}
          </div>
        </aside>
      </div>

      <div class="column">
        <div class="box is-paddingless">
          <nav class="level is-paddingless border-bottom is-mobile">
            <div class="level-item border-right">
              <span class="title right-m-10 left-m-10">{{ poll.get_questions.count }}</span>
              <span>{% trans "Question" %}{{ poll.get_questions.count|pluralize }}</span>
              <span class="tooltip top left-m-10">
                <i class="material-icons info-icon">info</i>
                <span class="tooltip-content">{% trans 'The amount of questions in this survey'%}</span>
              </span>
            </div>
            <div class="level-item">
              <i class="material-icons export-icon right-m-5">save_alt</i>
              <span>Export</span>
              <span class="tooltip top left-m-10">
              <i class="material-icons info-icon">info</i>
              <span class="tooltip-content">{% trans 'Export results on .csv format'%}</span>
            </span>
            </div>
          </nav>
          <div class="p-30 bottom-p-10">
            <div class="bottom-m-40">{{ poll.poll_date|date:"F d, Y" }}</div>
            <div class="columns bottom-m-20">
              <div class="column is-2 has-text-right">{% trans 'Title:'%}</div>
              <div class="column"><strong>{{ poll.title }}</strong></div>
            </div>
            <div class="columns bottom-m-20">
              {% if poll.response_content %}
                <div class="column is-2 has-text-right">{% trans 'Description:'%}</div>
                <div class="column">{{ poll.response_content }}</div>
              {% endif %}
            </div>
            <div class="columns bottom-m-10">
              <div class="column is-2 has-text-right">{% trans 'Linked SDGs:'%}</div>
              <div class="column">
                {% for sdg in poll.questions.distinct|get_value_in_qs:'sdgs' %}
                  <span class="tag sdg-{{ sdg }} is-medium right-m-5 bottom-m-5">{{ sdg }} {{ sdg|get_sdg }}</span>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="columns is-multiline">
          {% for question in poll.get_questions %}
          <div class="column is-half">
            <div class="box">
              <div class="survey-question">
                <div class="survey-question__number">{{ forloop.counter }}</div>
                <div class="survey-question__info">
                  <span class="survey-question__info__title">{{ question.title }}</span>
                  <div class="top-m-20">
                    <span class="right-m-30">{% trans 'Answered:'%} {{ question.get_responded|intcomma }}</span>
                    <span>{% trans 'Skipped:'%} {{ question.get_polled|intcomma }}</span>
                  </div>
                  <div class="top-m-30">
                    {% for sdg in question.sdgs %}
                    <span class="tag sdg-{{ sdg }} is-medium right-m-5 bottom-m-5">{{ sdg }} {{ sdg|get_sdg }}</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
              {% if not question.is_open_ended %}
              <div class="is-pulled-right">
                <div class="dropdown is-hoverable is-right bottom-m-10">
                  <div class="dropdown-trigger">
                    <div aria-haspopup="true" aria-controls="dropdown-menu">
                      <span>{% trans "Segment by" %}</span>
                      <span class="icon is-small">
                        <i class="fas fa-angle-down" aria-hidden="true"></i>
                      </span>
                    </div>
                  </div>

                  <div class="dropdown-menu" id="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                      <a href="#" class="dropdown-item">{% trans "All" %}</a>
                      {% if not is_iorg and show_gender_stats %} 
                        <a href="#" class="dropdown-item">{% trans "Gender" %}</a>
                      {% endif %}

                      {% if not is_iorg and show_age_stats %} 
                        <a href="#" class="dropdown-item">{% trans "Age" %}</a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              {% with results=question|question_results %}
                {% with categories=results.categories %}
                  {% for category in categories %}
                    <div
                      class="chart-question-{{ question.pk }}-category"
                      data-category="{{ category.label }}"
                      data-percentage="{% widthratio category.count results.set 100 %}">
                    </div>
                  {% endfor %}
                {% endwith %}
              {% endwith %}
              {% endif %}
              <div
                id="chart-question-{{ question.pk }}"
                data-question="{{ question.pk }}"
                data-question-type="{% if question.is_open_ended %}cloud{% else  %}chart{% endif %}">
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block js_extra %}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="{% static 'plugins/wordcloud/d3.js' %}"></script>
  <script src="{% static 'plugins/wordcloud/d3.layout.cloud.js' %}"></script>

  <script type="text/javascript">
    // mocked charts
    // let donutOptions = {
    //   chart: { type: 'donut' },
    //   legend: { position: 'top', horizontalAlign: 'center', fontSize: '16px', onItemClick: { toggleDataSeries: true }},
    //   colors: ['#03aeef', '#0400a4'],
    //   series: [50, 50],
    //   labels: ['Yes', 'No'],
    //   plotOptions: { pie: { size: 170 }},
    //   dataLabels: { formatter: function (val) { return val + "%" }, style: { fontSize: '16px'}},
    //   tooltip: { enabled: false },
    // };

    // let lineOptions = {
    //   chart: { height: 350, type: 'line', toolbar: { show: false }},
    //   legend: { position: 'top', horizontalAlign: 'center', fontSize: '16px', onItemClick: { toggleDataSeries: true }, itemMargin: { horizontal: 10, vertical: 10 }},
    //   grid: { row: { colors: ['transparent'], opacity: 0.5 }},
    //   stroke: { curve: 'smooth' },
    //   colors: ['#89e7ff', '#03aeef', '#0054e2', '#0400a4'],
    //   xaxis: { categories: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'] },
    //   series: [
    //     { name: "14 or less", data: [10, 22, 35, 45, 30, 42, 40, 45, 60, 65] },
    //     { name: "15 - 25", data: [5, 10, 22, 35, 26, 40, 45, 30, 52, 46] },
    //     { name: "26-40", data: [22, 36, 18, 28, 48, 62, 10, 51, 49, 30] },
    //     { name: "41 or more", data: [10, 41, 35, 51, 49, 62, 69, 28, 68, 39] }
    //   ],
    // };

    // let barOptions = {
    //   chart: { height: 350, type: 'bar', stacked: true, toolbar: { show: false }},
    //   plotOptions: { bar: { horizontal: true }},
    //   legend: { position: 'top', horizontalAlign: 'center', fontSize: '16px', onItemClick: { toggleDataSeries: true }, itemMargin: { horizontal: 10, vertical: 10 }},
    //   grid: { row: { colors: ['transparent'], opacity: 0.5 }},
    //   dataLabels: { enabled: false },
    //   colors: ['#89e7ff', '#03aeef', '#0054e2', '#0400a4'],
    //   xaxis: { categories: ['14 or less', '15 - 25', '26-40', '41 or more']},
    //   series: [
    //     { name: "Sometimes", data: [10, 22, 35, 45] },
    //     { name: "Often", data: [5, 10, 22, 35] },
    //     { name: "Always", data: [22, 36, 18, 28] },
    //     { name: "Rarely", data: [10, 41, 35, 51] }
    //   ],
    // };

    // let donutChart = new ApexCharts(
    //   document.querySelector("#donutChart"),
    //   donutOptions
    // );

    // let lineChart = new ApexCharts(
    //   document.querySelector("#lineChart"),
    //   lineOptions
    // );

    // let barChart = new ApexCharts(
    //   document.querySelector("#barChart"),
    //   barOptions
    // );

    // donutChart.render();
    // lineChart.render();
    // barChart.render();

    const results = [];

    $("div[data-question-type=\"chart\"]").each(function() {
      const question = $(this).attr("data-question");
      const labels = [];
      const series = [];
      const colors = [];

      $.each($(".chart-question-" + question + "-category"), function() {
        labels.push($(this).attr("data-category"));
        series.push(parseInt($(this).attr("data-percentage")));
        colors.push("#" + Math.floor(Math.random()*16777215).toString(16));
      });

      let donutOptions = {
        chart: { type: 'donut' },
        legend: { position: 'top', horizontalAlign: 'center', fontSize: '16px', onItemClick: { toggleDataSeries: true }},
      colors: colors,
      series: series,
      labels: labels,
        plotOptions: { pie: { size: 170 }},
        // dataLabels: { formatter: function (val) { return val + "%" }, style: { fontSize: '16px'}},
        tooltip: { enabled: false },
      };

      console.log(series);

      let donutChart = new ApexCharts(
        document.querySelector("#chart-question-" + question),
        donutOptions
      )
      donutChart.render();
    });

    const availableWordCloudColors = [
      "#89e7ff",
      "#03aeef",
      "#0054e2",
      "#0400a4",
    ];

    const fillWordColor = function(d, i) {
      return availableWordCloudColors[i % availableWordCloudColors.length];
    }

    $("div[data-question-type=\"cloud\"]").each(function() {
      const question = $(this).attr("data-question");
      const words = [];

      $.ajax({url: `/results/survey/${question}/pollquestion/`, dataType: "json"}).done(function(result) {
        if (!result) {
          return;
        }

        const results = result[0];
        results["categories"].map(function(word, index) {
          word = results.categories[index];
          if (word) {
            words.push({
              text: word.label.trim().toUpperCase(),
              size: 20 + word.count,
            });
          }
        });

        if (words.length > 0) {
          let wordCloud = d3.scale.category20();
          d3.layout.cloud()
            .words(words)
            .rotate(function() { return ~~(Math.random() * 2) * 90; })
            .font("Impact")
            .fontSize(function(d) { return d.size; })
            .on("end", draw)
            .start();

          function draw(words) {
            d3.select("#chart-question-" + question).append("svg")
              .attr("width", 340)
              .attr("height", 340)
              .append("g")
              .attr("transform", "translate(150,150)")
              .selectAll("text")
              .data(words)
              .enter().append("text")
              .style("font-size", function(d) {
                return d.size + "px";
              })
              .style("font-family", "Impact")
              .style("fill", function (d, i) {
                return wordCloud(i);
              })
              .attr("text-anchor", "middle")
              .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
              })
              .style('fill', fillWordColor)
              .text(function (d) {
                return d.text;
              });
          }
        }
      });
    });
  </script>
{% endblock %}
