
{% extends "base.html" %}
{% load i18n static sass_tags humanize ureport %}

{% block nav_item %}page-surveys{% endblock %}

{% block css_extra %}
  <link rel="stylesheet" href="{% static 'plugins/checkbox/checkbox.min.css' %}">
  <link rel="stylesheet" href="{% sass_src 'plugins/tooltip/tooltip.scss' %}">
  <link rel="stylesheet" href="{% sass_src 'css/polls/survey_results.scss' %}"/>
{% endblock %}

{% block content %}
  <section class="section top-p-0 bottom-p-0">
    <nav class="breadcrumb" aria-label="breadcrumbs">
      <ul>
        <li><a href="{% url 'polls_global.poll_list' %}">{% trans 'Global Surveys'%}</a></li>
        <li class="is-active"><a href="#" aria-current="page">{{ poll.title }}</a></li>
      </ul>
    </nav>
  </section>

  <section class="section">
    <h1 class="title">{% trans 'Survey Results'%}</h1>
  </section>

  <div class="section">
    <div class="columns is-mobile">
      <div class="column is-one-third-mobile is-one-quarter">
        <aside class="survey-filters">
          <div class="border-bottom p-30">
            <h3 class="bottom-m-10">
              <img class="right-m-5" src="{% static 'svg/unct.svg' %}" alt="">
              <span>UNCTs</span>
            </h3>
            <div class="control has-icons-left">
              <form>
                <input class="input is-medium search" name="query" placeholder="{% trans 'Search'%}" value="{{ query }}">
                <span class="icon is-left">
                <i class="material-icons">search</i>
              </span>
              </form>
            </div>
          </div>
          <div class="survey-filters-content p-30">
            <h3 class="bottom-m-10">
              <img class="right-m-5" src="{% static 'svg/sdg.svg' %}" alt="">
              <span>SDG</span>
            </h3>

            {% for sdg in sdgs %}
            <div class="sdg-checkbox">
              <input class="is-checkradio" name="sdgs" type="checkbox" value="{{ sdg.0 }}" id="sdg{{ sdg.0 }}"/>
              <label for="sdg{{ sdg.0 }}" title="{{ sdg.1 }}"><strong>{{ sdg.0 }}</strong> {{ sdg.1 }}</label>
            </div>
            {% endfor %}
          </div>
        </aside>
      </div>

      <div class="column">
        <div class="box is-paddingless">
          <nav class="level is-paddingless border-bottom is-mobile">
            <div class="level-item border-right">
              <span class="title right-m-10 left-m-10">{{ poll.get_questions.count }}</span>
              <span>{% trans "Question" %}{{ poll.get_questions.count|pluralize }}</span>
              <span class="tooltip top left-m-10">
                <i class="material-icons info-icon">info</i>
                <span class="tooltip-content">{% trans 'The amount of questions in this survey'%}</span>
              </span>
            </div>
            <div class="level-item">
              <img class="right-m-5" src="{% static 'svg/earth-globe.svg' %}" alt="">
              <div class="dropdown is-hoverable">
                <div class="dropdown-trigger">
                  <span aria-haspopup="true" aria-controls="countries-dropdown">
                    <span class="title right-m-10 left-m-10">30</span>
                    <span>{% trans "Countries" %}</span>
                    <span class="icon is-small">
                      <i class="fas fa-angle-down" aria-hidden="true"></i>
                    </span>
                  </span>
                </div>
                <div class="dropdown-menu" id="countries-dropdown" role="menu">
                  <div class="dropdown-content">
                    <div class="dropdown-item"><span>Country 1</span></div>
                    <div class="dropdown-item"><span>Country 2</span></div>
                    <div class="dropdown-item"><span>Country 3</span></div>
                    <div class="dropdown-item"><span>Country 4</span></div>
                    <div class="dropdown-item"><span>Country 5</span></div>
                  </div>
                </div>
              </div>
              <span class="tooltip top left-m-10">
                <i class="material-icons info-icon">info</i>
                <span class="tooltip-content">{% trans 'Countries participating in this global survey'%}</span>
              </span>
            </div>
            <div class="level-item border-left">
              <i class="material-icons export-icon right-m-5">save_alt</i>
              <span>Export</span>
              <span class="tooltip top left-m-10">
              <i class="material-icons info-icon">info</i>
              <span class="tooltip-content">{% trans 'Export results on .csv format'%}</span>
            </span>
            </div>
          </nav>
          <div class="bottom-p-20">
            <div class="columns bottom-m-10">
              <div class="column is-2 has-text-right">{% trans 'Title:'%}</div>
              <div class="column"><strong>{{ poll.title }}</strong></div>
            </div>
            <div class="columns bottom-m-10">
              {% if poll.response_content %}
              <div class="column is-2 has-text-right">{% trans 'Description:'%}</div>
              <div class="column">{{ poll.response_content }}</div>
              {% endif %}
            </div>
            <div class="columns bottom-m-10">
              <div class="column is-2 has-text-right">{% trans 'Date:'%}</div>
              <div class="column">{{ poll.poll_date|date:"m/d/Y" }}</div>
            </div>
            <div class="columns bottom-m-10">
              <div class="column is-2 has-text-right">{% trans 'Linked SDGs:'%}</div>
              <div class="column">
                {% for sdg in poll.questions.distinct|get_value_in_qs:'sdgs' %}
                <span class="tag sdg-{{ sdg }} right-m-5 bottom-m-5">{{ sdg }} {{ sdg|get_sdg }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="columns bottom-m-10">
              <div class="column is-2 has-text-right">{% trans 'Last answer:'%}</div>
              <div class="column">{{ poll|get_poll_sync_status }}</div>
            </div>
          </div>
        </div>

        {% for question in poll.get_questions %}
          <div class="global-survey-card box is-paddingless" x-data="accordion()" data-question-sdgs="{{ question.sdgs|join:',' }}">
            <div class="survey-question">
              <div class="survey-question__number">{{ forloop.counter }}</div>
              <div class="survey-question__info">
                <span class="survey-question__info__title">{{ question.title }}</span>
                <div class="top-m-20">
                  <span class="right-m-30">{% trans 'Answered:'%} {{ question.get_responded|intcomma }}</span>
                  <span>{% trans 'Polled:'%} {{ question.get_polled|intcomma }}</span>
                </div>
                <div class="top-m-30 flex space-between">
                  <div>
                    {% for sdg in question.sdgs %}
                      <span class="tag sdg-{{ sdg }} right-m-5 bottom-m-5">{{ sdg }} {{ sdg|get_sdg }}</span>
                    {% endfor %}
                  </div>
                  <div class="accordion-btn" x-on:click="toggle()">
                    <span x-show="!isOpen()">
                      More
                      <i class="material-icons">keyboard_arrow_down</i>
                    </span>
                    <span x-show="isOpen()">
                      Less
                      <i class="material-icons">keyboard_arrow_up</i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="global-survey-chart" x-show="isOpen()">
              <div class="columns is-marginless">
                <div class="column border-top border-bottom p-30 has-text-centered">
                  <img class="right-m-5" src="{% static 'svg/business-affiliate-network.svg' %}" alt="">
                  <span class="has-text-weight-bold right-m-10 left-m-10">60%</span>
                  <span>{% trans "Participating UNCT" %}</span>
                </div>
                {% if not question.is_open_ended %}
                  <div class="column border-top border-bottom border-left p-30 has-text-centered">
                    <div class="dropdown is-hoverable is-right">
                      <div class="dropdown-trigger">
                        <div aria-haspopup="true" aria-controls="dropdown-menu">
                          <span>{% trans "Segment by" %}</span>
                          <span class="icon is-small">
                            <i class="fas fa-angle-down" aria-hidden="true"></i>
                          </span>
                        </div>
                      </div>
                      <div class="dropdown-menu" id="dropdown-menu" role="menu">
                        <div class="dropdown-content">
                          <a href="javascript:showChart('statistics', {{ question.pk }});" class="dropdown-item statistics">{% trans "All" %}</a>
                          {% if not is_iorg and show_gender_stats %}
                          <a href="javascript:showChart('gender', {{ question.pk }});" class="dropdown-item gender">{% trans "Gender" %}</a>
                          {% endif %}
                          {% if not is_iorg and show_age_stats %}
                          <a href="javascript:showChart('age', {{ question.pk }});" class="dropdown-item age">{% trans "Age" %}</a>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>

              <div class="columns p-30">
                <div class="column">
                  <div class="has-text-weight-bold">Global</div>
                  {% if not question.is_open_ended %}
                    <canvas
                      id="chart-question-{{ question.pk }}"
                      width="300"
                      height="300"
                      data-question="{{ question.pk }}"
                      data-question-type="chart"
                      class="has-text-centered">
                    </canvas>
                  {% else %}
                    <div
                      class="has-text-centered"
                      id="chart-question-cloud-{{ question.pk }}"
                      data-question="{{ question.pk }}"
                      data-question-type="cloud">
                    </div>
                  {% endif %}
                </div>
                <div class="column">
                  <div class="has-text-weight-bold">UNCT</div>
                  {% if not question.is_open_ended %}
                  <canvas
                          id="chart-question-{{ question.pk }}"
                          width="300"
                          height="300"
                          data-question="{{ question.pk }}"
                          data-question-type="chart"
                          class="has-text-centered">
                  </canvas>
                  {% else %}
                  <div
                          class="has-text-centered"
                          id="chart-question-cloud-{{ question.pk }}"
                          data-question="{{ question.pk }}"
                          data-question-type="cloud">
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block js_extra %}
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/calebporzio/project-x@v0.4.0/dist/project-x.min.js" defer></script>

  <script type="text/javascript">
    $("input:checkbox").click(function() {
      let isChecked = $("input:checkbox").filter(":checked");

      isChecked.map(function() {
        let sdg = this.value;

        $("div[data-question-sdgs]").each(function() {
          let sdgs = $(this).attr("data-question-sdgs");

          if (!sdgs.split(",").includes(sdg)) {
            $(this).hide();
          } else {
            $(this).show();
          }
        });
      });

      if (isChecked.length == 0) {
        $("div[data-question-sdgs]").each(function() {
          $(this).show();
        });
      }
    });

    function accordion() {
        return {
            show: false,
            toggle() { this.show = !this.show },
            isOpen() { return this.show === true },
        };
    }
  </script>
{% endblock %}
